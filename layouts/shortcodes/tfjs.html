{{ $id := .Get "id" | default "tfjs-demo" }}

<div id="tfjs-container-{{ $id }}" class="tfjs-container">
  <div class="tfjs-controls">
    <button id="train-{{ $id }}" class="train-button">Train Model</button>
    <button id="predict-{{ $id }}" class="predict-button">Make Prediction</button>
  </div>
  <div class="tfjs-output">
    <div id="status-{{ $id }}" class="status">Status: Ready</div>
    <div id="result-{{ $id }}" class="result"></div>
  </div>
</div>

<style>
.tfjs-container { margin: 1em 0; }
.tfjs-controls { margin-bottom: 1em; }
.train-button, .predict-button { 
  padding: 0.5em 1em;
  margin-right: 0.5em;
  cursor: pointer;
}
.status { margin-bottom: 0.5em; }
.result { 
  padding: 1em;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-family: monospace;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const container = document.getElementById('tfjs-container-{{ $id }}');
  const trainBtn = document.getElementById('train-{{ $id }}');
  const predictBtn = document.getElementById('predict-{{ $id }}');
  const status = document.getElementById('status-{{ $id }}');
  const result = document.getElementById('result-{{ $id }}');
  
  // Create a simple model
  const model = tf.sequential();
  model.add(tf.layers.dense({units: 1, inputShape: [1]}));
  model.compile({optimizer: 'sgd', loss: 'meanSquaredError'});
  
  // Generate some training data
  const xs = tf.tensor2d([1, 2, 3, 4], [4, 1]);
  const ys = tf.tensor2d([2, 4, 6, 8], [4, 1]); // y = 2x
  
  let isTrained = false;
  
  trainBtn.addEventListener('click', async function() {
    status.textContent = 'Status: Training...';
    trainBtn.disabled = true;
    
    try {
      await model.fit(xs, ys, {
        epochs: 100,
        callbacks: {
          onEpochEnd: (epoch, logs) => {
            if (epoch % 20 === 0) {
              status.textContent = `Status: Training... Epoch ${epoch}, Loss: ${logs.loss.toFixed(4)}`;
            }
          }
        }
      });
      
      isTrained = true;
      status.textContent = 'Status: Training complete!';
      predictBtn.disabled = false;
    } catch (error) {
      status.textContent = 'Status: Error during training';
      console.error(error);
    }
  });
  
  predictBtn.addEventListener('click', function() {
    if (!isTrained) {
      status.textContent = 'Status: Please train the model first';
      return;
    }
    
    // Make a prediction for x = 5
    const prediction = model.predict(tf.tensor2d([5], [1, 1]));
    prediction.data().then(data => {
      result.textContent = `Input: 5\nPredicted output: ${data[0].toFixed(2)}\nExpected output: 10`;
    });
  });
  
  // Initially disable predict button
  predictBtn.disabled = true;
});
</script> 